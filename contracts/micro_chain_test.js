const Chain3 = require("chain3");
const fs = require("fs");
const solc = require("solc");

var mainaddress = "0xad9d80a7b374f23d2ddfa0febbd43edcad41c9a5";
var createboardaddress = "0x44c10f4cd26dbb33b0cc3bd8d9fb4e313498cfa0";

const vnodeUri = "http://127.0.0.1:8999";
var address = "";
let chain3 = new Chain3();
chain3.setProvider(new chain3.providers.HttpProvider(vnodeUri));

if (!chain3.isConnected()) {
  throw new Error("unable to connect to moac vnode at " + vnodeUri);
} else {
  console.log("connected to moac vnode at " + vnodeUri);
  let coinbase = mainaddress;
  console.log("mainaddress:" + coinbase);
  let balance = chain3.mc.getBalance(coinbase);
  console.log("balance:" + balance / 1000000000000000000 + " MC");

  console.log("createboardaddress:" + createboardaddress);
  balance = chain3.mc.getBalance(createboardaddress);
  console.log("balance:" + balance / 1000000000000000000 + " MC");

  let accounts = chain3.mc.accounts;
  console.log(accounts);

  address = coinbase;
  if (chain3.personal.unlockAccount(address, "test", 0)) {
    console.log(`${address} is unlocked`);
  } else {
    console.log(`unlock failed, ${address}`);
    throw new Error("unlock failed " + address);
  }

  address = createboardaddress;
  if (chain3.personal.unlockAccount(address, "moac", 0)) {
    console.log(`${address} is unlocked`);
  } else {
    console.log(`createboardaddress unlock failed, ${address}`);
    throw new Error("createboardaddress unlock failed " + address);
  }
}



//==========================================================================
//==========================================================================
console.log("### Deploying the subchainprotocolbaseContract");

var contract = fs.readFileSync(
  "../../../../../contracts/SubChainProtocolBase.sol",
  "utf8"
);

var output = solc.compile(contract, 1);

var abi = output.contracts[":SubChainProtocolBase"].interface;
var bin = output.contracts[":SubChainProtocolBase"].bytecode;

var protocol = "POR";
var bmin = 3;
var subchainprotocolbaseContract = chain3.mc.contract(JSON.parse(abi));
var subchainprotocolbase = subchainprotocolbaseContract.new(protocol, bmin, {
  from: mainaddress,
  data: "0x" + bin,
  gas: "9000000"
});

console.log(
  "subchainprotocolbaseContract is being deployed transaction: " +
    subchainprotocolbase.transactionHash
);
waitBlock(subchainprotocolbase.transactionHash);
subchainprotocolbase = subchainprotocolbaseContract.at(
  chain3.mc.getTransactionReceipt(subchainprotocolbase.transactionHash)
    .contractAddress
);

//==========================================================================
//==========================================================================
console.log("### Deploying the vnodeprotocolbaseContract");

var contract = fs.readFileSync(
  "../../../../../contracts/VnodeProtocolBase.sol",
  "utf8"
);

var output = solc.compile(contract, 1);

var abi = output.contracts[":VnodeProtocolBase"].interface;
var bin = output.contracts[":VnodeProtocolBase"].bytecode;

var bmin = 1;
var vnodeprotocolbaseContract = chain3.mc.contract(JSON.parse(abi));
var vnodeprotocolbase = vnodeprotocolbaseContract.new(bmin, {
  from: mainaddress,
  data: "0x" + bin,
  gas: "4700000"
});

console.log(
  "vnodeprotocolbaseContract is being deployed transaction: " +
    vnodeprotocolbase.transactionHash
);
waitBlock(vnodeprotocolbase.transactionHash);
vnodeprotocolbase = vnodeprotocolbaseContract.at(
  chain3.mc.getTransactionReceipt(vnodeprotocolbase.transactionHash)
    .contractAddress
);

//==========================================================================
//==========================================================================

console.log("### Deploying the subchainbaseContract");

var input = {
  "": fs.readFileSync("../../../../../contracts/SubChainBase.sol", "utf8"),
  "SubChainProtocolBase.sol": fs.readFileSync(
    "../../../../../contracts/SubChainProtocolBase.sol",
    "utf8"
  )
};

var output = solc.compile({ sources: input }, 1);

var abi = output.contracts[":SubChainBase"].interface;
var bin = output.contracts[":SubChainBase"].bytecode;

console.log("subchainprotocolbase.address:" + subchainprotocolbase.address);
console.log("vnodeprotocolbase.address:" + vnodeprotocolbase.address);

var proto = subchainprotocolbase.address;
var vnodeProtocolBaseAddr = vnodeprotocolbase.address;
var min = 1;
var max = 10;
var thousandth = 1;
var flushRound = 20;
var subchainbaseContract = chain3.mc.contract(JSON.parse(abi));
var subchainbase = subchainbaseContract.new(
  proto,
  vnodeProtocolBaseAddr,
  min,
  max,
  thousandth,
  flushRound,
  {
    from: mainaddress,
    data: "0x" + bin,
    gas: "9000000"
  }
);

console.log(
  "subchainbaseContract is being deployed transaction: " +
    subchainbase.transactionHash
);
waitBlock(subchainbase.transactionHash);
subchainbase = subchainbaseContract.at(
  chain3.mc.getTransactionReceipt(subchainbase.transactionHash).contractAddress
);

//==========================================================================
//0xaE6E5aBe58B63Ab7129fF77c6d2c000F5b2F0244
//0x8A6c516367EadB886B36197300DEaaB7BE5867DC
//0xb1fe3ec07271F7Df21871314E05EdB463be05890
//
//==========================================================================
console.log("### Sending MC to scs1, scs2, scs3 and scsm");
scs1 = "0x6806344fd25bea9a038f5fe122bb6ac33eea7812";
sendtx(mainaddress, scs1, 20);
waitBalance(scs1, 20);

scs2 = "0x21ad8520c9ddb6b982b9a01e915f8900a65560a3";
sendtx(mainaddress, scs2, 20);
waitBalance(scs2, 20);

scs3 = "0x61f97cc6c1457f3bf31e249a6d68d1fc06298947";
sendtx(mainaddress, scs3, 20);
waitBalance(scs3, 20);

scsm = "0xe543dd0656ed71984d31b9d18692fd6bc9ce43d0";
sendtx(mainaddress, scsm, 20);
waitBalance(scsm, 20);

// scsm="0x3e0025B9fCDC70B7cf63A6c087345aFFE2Df7301";
// sendtx(cmainaddress, scsm, 20);
// waitBalance(scsm, 20);

addfundtosubchain(subchainbase.address);
waitBalance(subchainbase.address, 10);

//==========================================================================
//==========================================================================
console.log("### Registering SCS to the pool");

registertopool(subchainprotocolbase.address, scs1);
registertopool(subchainprotocolbase.address, scs2);
registertopool(subchainprotocolbase.address, scs3);

while (true) {
  let count = subchainprotocolbase.scsCount();
  if (count > 2) {
    console.log("registertopool has enough scs " + count);
    break;
  }
  console.log("Waiting registertopool, current scs count=" + count);
  sleep(5000);
}

let scslist = subchainprotocolbase.scsList(scs3);
//let scslist=subchainprotocolbase.scsList(scs1);
console.log(scslist);

let startnum = chain3.mc.blockNumber;
while (true) {
  let number = chain3.mc.blockNumber;
  if (number > startnum + 5) {
    console.log("reached target block number " + number);
    break;
  }
  console.log("Waiting block number, current block number=" + number);
  sleep(5000);
}

console.log("### Trigger Register OPEN ...");
registeropen();

console.log("### Register OPEN is waiting for SCS ...");
while (true) {
  let count = subchainbase.nodeCount();
  if (count > 0) {
    console.log("registertopool has enough scs " + count);
    break;
  }
  console.log("Waiting registertopool, current scs count=" + count);
  sleep(5000);
}

console.log("### Register CLOSE ...");
registerclose();
sleep(15000);

console.log("### Register SCS Monitor");
subchainRegisterAsMonitor(scsm, bmin);

//==========================================================================
//==========================================================================
console.log("### Waiting for the subchain initialization ...");
sleep(40000);

console.log("### Deploying the lianwen subchain ...");
var baseaddr = mainaddress;
var nonce = 0;

deChatDeploy(baseaddr, subchainbase.address, nonce);

sleep(15000);

//==========================================================================
//==========================================================================
console.log("### Add the new LianWen channel to LianWen Board ...");

var dechatmanagementaddr = "0x262c6ffc3b579fd932266ed6a646de5077ebe78b";
var dechatmanagementAbi =
  '[{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"boardList","outputs":[{"name":"subchainAddr","type":"address"},{"name":"deployLwSolAdmin","type":"address"},{"name":"marketableTokenAddr","type":"address"},{"name":"rpcIp","type":"bytes32"},{"name":"boardName","type":"bytes32"},{"name":"picPath","type":"bytes32"},{"name":"boardStatus","type":"uint256"},{"name":"exchangeRate","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"status","type":"uint256"},{"name":"subchainAddr","type":"address"}],"name":"updateBoardStatus","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"status","type":"uint256"}],"name":"getBoardlist","outputs":[{"name":"","type":"address[]"},{"name":"","type":"bytes32[]"},{"name":"","type":"uint256[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"subchainAddr","type":"address"},{"name":"deployLwSolAdmin","type":"address"},{"name":"marketableTokenAddr","type":"address"},{"name":"rpcIp","type":"bytes32"},{"name":"boardName","type":"bytes32"},{"name":"picPath","type":"bytes32"},{"name":"exchangeRate","type":"uint256"}],"name":"creatBoard","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":true,"stateMutability":"payable","type":"constructor"}]';

var dechatmanagementContract = chain3.mc.contract(
  JSON.parse(dechatmanagementAbi)
);
var dechatmanagement = dechatmanagementContract.at(dechatmanagementaddr);

var deployLwSolAdmin = mainaddress;
var marketableTokenAddr = "0x94915fcb066ce1c965a8c8178e289b22d7824900";
var rpcIp = "http://52.42.170.217:8548/rpc";

var boardName = "MoacDemoTest";
const args = process.argv.slice(2);
if (args.length > 0) {
  boardName = args[0];
}
console.log("### Lianwen name: " + boardName);
var picPath = "wwww.test.com/test.img";
var num = 10;

creatBoard(
  createboardaddress,
  subchainbase.address,
  deployLwSolAdmin,
  marketableTokenAddr,
  rpcIp,
  boardName,
  picPath,
  num
);

console.log("### Creating board done!");

//==========================================================================
//==========================================================================

console.log("### All done!!!\n");
sleep(1000);
console.log("Please go to testnet.moac.io to monitor the microchain.\n");
sleep(1000);
console.log("Subchain Base Address: " + subchainbase.address + "\n");
sleep(1000);
console.log("IP: 52.42.170.217\n");
console.log("Port: 8548\n");

function registertopool(contractadd, scsaddress) {
  var registerdata =
    "0x4420e486000000000000000000000000" + scsaddress.substring(2);
  sendtx(mainaddress, contractadd, 12, registerdata);
}

function registeropen() {
  sendtx(mainaddress, subchainbase.address, 0, "0x5defc56c");
}

function addfundtosubchain() {
  sendtx(mainaddress, subchainbase.address, 10, "0xa2f09dfa");
}

function registerclose() {
  sendtx(mainaddress, subchainbase.address, 0, "0x69f3576f");
}

function subchainRegisterAsMonitor(scsAddr, coins) {
  sendtx(
    mainaddress,
    subchainbase.address,
    coins,
    "0x4e592e2f000000000000000000000000" + scsAddr.substring(2)
  );
}

function waitBlock(transactionHash) {
  while (true) {
    let receipt = chain3.mc.getTransactionReceipt(transactionHash);
    if (receipt && receipt.contractAddress) {
      console.log("contract has been deployed at " + receipt.contractAddress);
      break;
    }
    console.log(
      "Waiting a mined block to include your contract... currently in block " +
        chain3.mc.blockNumber
    );
    sleep(5000);
  }
}

function waitBalance(addr, target) {
  while (true) {
    let balance = chain3.mc.getBalance(addr) / 1000000000000000000;
    if (balance >= target) {
      console.log("account has enough balance " + balance);
      break;
    }
    console.log("Waiting the account has enough balance " + balance);
    sleep(5000);
  }
}

function sendtx(src, tgtaddr, amount, strData) {
  chain3.mc.sendTransaction({
    from: src,
    value: chain3.toSha(amount, "mc"),
    to: tgtaddr,
    gas: "2000000",
    gasPrice: chain3.mc.gasPrice,
    data: strData
  });

  console.log(
    "sending from:" +
      src +
      " to:" +
      tgtaddr +
      " amount:" +
      amount +
      " with data:" +
      strData
  );
}

function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e70; i++) {
    if (new Date().getTime() - start > milliseconds) {
      break;
    }
  }
}

//==========================

function deChatDeploy(baseaddr, subchainaddr, nonce) {
  var code =
    "0x606060405267016345785d8a0000600d556032600e556014600f55601460105560096011556001601255606460135560c860145560646019556064601a5560405160408062003c7a83398101604052620000639067800000000000000090620000cb565b60048054600160a060020a031990811633600160a060020a0390811691821790935543600c5560158054831690911790556017805482169483169490941790935560168054909316911617905562000116565b6000620000c482516200010a565b9392505050565b60008060408385031215620000df57600080fd5b6000620000ed8585620000b6565b92505060206200010085828601620000b6565b9150509250929050565b600160a060020a031690565b613b5480620001266000396000f3006060604052600436106101cc5763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416630f2fbeec81146101d157806310ba049914610210578063147d78d91461023b5780631b6226d7146102665780632e98520c1461029157806331a06771146102a4578063364f8745146102c45780633d70bc52146102d757806342c2b904146102ea57806357058a331461031b5780635760daf71461033b5780635b0c5dc61461034e5780635b1222b4146103795780635ea6747c146103a45780635f1f04bc146103c2578063696a8f3a146103e05780636f0fe78b146103fe578063752da5a31461041c5780638753818c1461044757806389739c5b146104655780638a922f471461046d578063934a51a214610480578063957bceff146104ad578063a9e0ba7f146104cb578063ab7deceb146104de578063ac4e083c146104fc578063b63a5f491461050f578063bf46ac4114610522578063c9f89b9314610540578063ccd050c51461056b578063cf8709601461057e578063d1ad7e3514610591578063db579464146105a4578063e20f23cb146105c2578063eb9d0715146105e0578063ec5f9319146105f3578063ed4dddf614610606575b600080fd5b34156101dc57600080fd5b6101ef6101ea36600461333b565b610619565b6040516102079c9b9a99989796959493929190613967565b60405180910390f35b341561021b57600080fd5b61022e6102293660046132f4565b610731565b60405161020791906138dc565b341561024657600080fd5b610259610254366004613433565b61078a565b60405161020791906138ba565b341561027157600080fd5b61028461027f36600461333b565b610a10565b60405161020791906138ea565b341561029c57600080fd5b610284610a2f565b34156102af57600080fd5b6102c26102bd3660046132bf565b610a35565b005b34156102cf57600080fd5b610284610c0f565b34156102e257600080fd5b610284610c15565b34156102f557600080fd5b61030861030336600461333b565b610c1b565b60405161020797969594939291906138f8565b341561032657600080fd5b61032e610d08565b6040516102079190613867565b341561034657600080fd5b610284610d71565b341561035957600080fd5b61036c61036736600461333b565b610d77565b6040516102079190613a32565b341561038457600080fd5b61039761039236600461333b565b610ed4565b6040516102079190613859565b34156103af57600080fd5b6102846103bd366004613414565b610efc565b34156103cd57600080fd5b6102846103db36600461333b565b610f2a565b34156103eb57600080fd5b6102846103f9366004613414565b610f3c565b341561040957600080fd5b6102c2610417366004613359565b6110e1565b341561042757600080fd5b61043a610435366004613212565b611377565b60405161020791906138cb565b341561045257600080fd5b61043a610460366004613414565b61153f565b6102c2611770565b341561047857600080fd5b6102c2611816565b341561048b57600080fd5b61049e610499366004613272565b611dbb565b60405161020793929190613878565b34156104b857600080fd5b6102846104c63660046133cc565b61210e565b34156104d657600080fd5b610284612239565b34156104e957600080fd5b6102846104f7366004613414565b61223f565b341561050757600080fd5b61028461225a565b341561051a57600080fd5b610284612260565b341561052d57600080fd5b61028461053b366004613414565b612266565b341561054b57600080fd5b61055e61055936600461333b565b6122c8565b6040516102079190613a21565b341561057657600080fd5b610284612456565b341561058957600080fd5b61039761245c565b61028461059f366004613454565b61246b565b34156105af57600080fd5b6101ef6105bd366004613238565b61271d565b34156105cd57600080fd5b6102846105db36600461333b565b6127d9565b34156105eb57600080fd5b610284612b2b565b34156105fe57600080fd5b610284612b31565b341561061157600080fd5b610284612b37565b60056020528060005260406000206000915090508060000154908060010160009054906101000a9004600160a060020a031690806002018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156106e45780601f106106b9576101008083540402835291602001916106e4565b820191906000526020600020905b8154815290600101906020018083116106c757829003601f168201915b50505050509080600301549080600401549080600501549080600601549080600701549080600801549080600901549080600a0160009054906101000a900460ff169080600b015490508c565b6000805b835181101561077e5782600160a060020a031684828151811061075457fe5b90602001906020020151600160a060020a031614156107765760019150610783565b600101610735565b600091505b5092915050565b610792612d31565b600080600061079f612d31565b60008815156107ad57600080fd5b6000898152600760205260409020548888029550600189018802945092508285106107df5760009450600093506107eb565b828411156107eb578293505b8484036040518059106107fb5750595b90808252806020026020018201604052801561083157816020015b61081e612d43565b8152602001906001900390816108165790505b5091508490505b83811015610a04576000898152600760205260408120805460069291908490811061085f57fe5b90600052602060002090015460001916600019168152602001908152602001600020610100604051908101604090815282548252600180840154600160a060020a0316602080850191909152600280860180549596958588019591948116156101000260001901169190910491601f8301819004810201905190810160405280929190818152602001828054600181600116156101000203166002900480156109495780601f1061091e57610100808354040283529160200191610949565b820191906000526020600020905b81548152906001019060200180831161092c57829003601f168201915b505050505081526020016003820154815260200160048201546000191660001916815260200160058201548152602001600682018054806020026020016040519081016040528092919081815260200182805480156109d157602002820191906000526020600020905b8154600160a060020a031681526001909101906020018083116109b3575b5050505050815260200160078201548152505082868303815181106109f257fe5b60209081029091010152600101610838565b50979650505050505050565b600a805482908110610a1e57fe5b600091825260209091200154905081565b600e5481565b6004546000908190819033600160a060020a0390811691161415610a68576001848051610a66929160200190612d94565b505b8360405180828051906020019060200280838360005b83811015610a96578082015183820152602001610a7e565b50505050905001915050604051809103902092506001604051808280548015610ae857602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311610aca575b5050915050604051908190039020915082821415610b0557610c09565b610b82600360008560001916600019168152602001908152602001600020805480602002602001604051908101604052809291908181526020018280548015610b7757602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311610b59575b505050505033610731565b9050801515610c09576000838152600360205260409020805460018101610ba98382612dfb565b5060009182526020909120018054600160a060020a03191633600160a060020a031617905560028451811515610bdb57fe5b600085815260036020526040902054919004901115610c09576001848051610c07929160200190612d94565b505b50505050565b60145481565b600f5481565b60066020528060005260406000206000915090508060000154908060010160009054906101000a9004600160a060020a031690806002018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ce65780601f10610cbb57610100808354040283529160200191610ce6565b820191906000526020600020905b815481529060010190602001808311610cc957829003601f168201915b5050505050908060030154908060040154908060050154908060070154905087565b610d10612d31565b6001805480602002602001604051908101604052809291908181526020018280548015610d6657602002820191906000526020600020905b8154600160a060020a03168152600190910190602001808311610d48575b505050505090505b90565b600d5481565b610d7f612e24565b811515610d8b57600080fd5b60008281526005602052604090819020906101809051908101604090815282548252600180840154600160a060020a0316602080850191909152600280860180549596958588019591948116156101000260001901169190910491601f830181900481020190519081016040528092919081815260200182805460018160011615610100020316600290048015610e635780601f10610e3857610100808354040283529160200191610e63565b820191906000526020600020905b815481529060010190602001808311610e4657829003601f168201915b505050918352505060038201546020820152600482015460408201526005820154606082015260068201546080820152600782015460a0820152600882015460c0820152600982015460e0820152600a82015460ff161515610100820152600b909101546101209091015292915050565b6001805482908110610ee257fe5b600091825260209091200154600160a060020a0316905081565b600760205281600052604060002081815481101515610f1757fe5b6000918252602090912001549150829050565b60096020526000908152604090205481565b601554600090819033600160a060020a0390811691161480610f6c575060175433600160a060020a039081169116145b1515610f7757600080fd5b831515610f8357600080fd5b5060008381526005602052604090819020600b8101849055906110d99082906101809051908101604090815282548252600180840154600160a060020a0316602080850191909152600280860180549596958588019591948116156101000260001901169190910491601f8301819004810201905190810160405280929190818152602001828054600181600116156101000203166002900480156110695780601f1061103e57610100808354040283529160200191611069565b820191906000526020600020905b81548152906001019060200180831161104c57829003601f168201915b505050918352505060038201546020820152600482015460408201526005820154606082015260068201546080820152600782015460a0820152600882015460c0820152600982015460e0820152600a82015460ff161515610100820152600b9091015461012090910152612b3d565b509192915050565b6000806111466001805480602002602001604051908101604052809291908181526020018280548015610b7757602002820191906000526020600020908154600160a060020a03168152600190910190602001808311610b5957505050505033610731565b151561115157600080fd5b825184511461115f57600080fd5b84848460405183815260208101838051906020019060200280838360005b8381101561119557808201518382015260200161117d565b50505050905001828051906020019060200280838360005b838110156111c55780820151838201526020016111ad565b5050505090500193505050506040519081900390206000818152600260208190526040909120015490925060ff16156111fd57610c07565b61127b600260008460001916600019168152602001908152602001600020600101805480602002602001604051908101604052809291908181526020018280548015610b7757602002820191906000526020600020908154600160a060020a03168152600190910190602001808311610b5957505050505033610731565b1515610c0757600082815260026020526040902060019081018054909181016112a48382612dfb565b5060009182526020909120018054600160a060020a03191633600160a060020a0316179055600154600290600084815260026020526040902060010154919004901115610c0757506000818152600260208190526040822001805460ff191660011790555b8351811015610c075783818151811061131e57fe5b90602001906020020151600160a060020a03166108fc84838151811061134057fe5b906020019060200201519081150290604051600060405180830381858888f19350505050151561136f57600080fd5b600101611309565b61137f612d31565b600160a060020a038216151561139457600080fd5b6018600083600160a060020a0316600160a060020a0316815260200190815260200160002080548060200260200160405190810160405281815291906000602084015b8282101561153457600084815260209020600c830201610180604051908101604090815282548252600180840154600160a060020a0316602080850191909152600280860180549596958588019591948116156101000260001901169190910491601f8301819004810201905190810160405280929190818152602001828054600181600116156101000203166002900480156114b55780601f1061148a576101008083540402835291602001916114b5565b820191906000526020600020905b81548152906001019060200180831161149857829003601f168201915b50505091835250506003820154602080830191909152600483015460408301526005830154606083015260068301546080830152600783015460a0830152600883015460c0830152600983015460e0830152600a83015460ff161515610100830152600b909201546101209091015290825260019290920191016113d7565b505050509050919050565b611547612d31565b6000806000611554612d31565b600a54878702945060018801870293509150600082851061157c576000945060009350611588565b82841115611588578293505b8484036040518059106115985750595b9080825280602002602001820160405280156115ce57816020015b6115bb612e24565b8152602001906001900390816115b35790505b5091508490505b838110156117655760056000600a838154811015156115f057fe5b90600052602060002090015460001916600019168152602001908152602001600020610180604051908101604090815282548252600180840154600160a060020a0316602080850191909152600280860180549596958588019591948116156101000260001901169190910491601f8301819004810201905190810160405280929190818152602001828054600181600116156101000203166002900480156116da5780601f106116af576101008083540402835291602001916116da565b820191906000526020600020905b8154815290600101906020018083116116bd57829003601f168201915b505050918352505060038201546020820152600482015460408201526005820154606082015260068201546080820152600782015460a0820152600882015460c0820152600982015460e0820152600a82015460ff161515610100820152600b9091015461012090910152828683038151811061175357fe5b602090810290910101526001016115d5565b509695505050505050565b43600090815260208190526040902080546001810161178f8382612dfb565b5060009182526020808320919091018054600160a060020a03191633600160a060020a03161790554382528190526040902060019081018054909181016117d68382612dfb565b506000918252602080832034920191909155438252819052604090206002018054600181016118058382612dfb565b506000918252602090912042910155565b600080600080600080600080600080600080600043600c5410151561183a57600080fd5b600c5460009d509b505b438c1015611d9a5760009a505b60008c8152600860205260409020548b10801561186f5750601a548b105b15611d8f5760008c815260086020526040902080548c90811061188e57fe5b60009182526020909120015499508915806118ba575060008a8152600560205260409020600a015460ff165b156118c457611d84565b60008a815260056020908152604080832060038101546007909101548085526006909352922060010154919e509950600160a060020a03161561198157600e5460008b8152600560205260409020600301546064910260008b8152600660205260409081902060010154929091049950600160a060020a039091169089156108fc02908a9051600060405180830381858888f19350505050151561196757600080fd5b60008981526006602052604090206003018890559b8790039b5b6000898152600660208190526040909120015460198190556013549011156119aa576013546019555b600096505b601954871015611a505760195460105460008c81526005602052604090206003015460649102048115156119df57fe5b60008b81526006602081905260409091200180549290910497509088908110611a0457fe5b600091825260209091200154600160a060020a031686156108fc0287604051600060405180830381858888f193505050501515611a4057600080fd5b9b8590039b6001909601956119af565b60008a815260056020908152604080832060090154808452600690925290912060010154909550600160a060020a031615611b0557600f5460008b815260056020526040902060030154606491026000878152600660205260409081902060010154929091049550600160a060020a039091169085156108fc0290869051600060405180830381858888f193505050501515611aeb57600080fd5b60008581526006602052604090206003018490559b8390039b5b601754600160a060020a031615611b6d5760115460008b815260056020526040902060030154606491026017549190049350600160a060020a031683156108fc0284604051600060405180830381858888f193505050501515611b6757600080fd5b828d039c505b601654600160a060020a031615611bef5760165460125460008c815260056020526040902060030154600160a060020a03909216916108fc9160649102049081150290604051600060405180830381858888f193505050501515611bd057600080fd5b60125460008b81526005602052604090206003015460649102048d039c505b60008d1115611c3d5760008a8152600560205260409081902060010154600160a060020a0316908e156108fc02908f9051600060405180830381858888f193505050501515611c3d57600080fd5b60008a81526005602052604090819020600a8101805460ff19166001179055611cfc916101809051908101604090815282548252600180840154600160a060020a0316602080850191909152600280860180549596958588019591948116156101000260001901169190910491601f8301819004810201905190810160405280929190818152602001828054600181600116156101000203166002900480156110695780601f1061103e57610100808354040283529160200191611069565b600a80546000198101908110611d0e57fe5b60009182526020808320909101548c8352600b909152604090912054600a8054929450909250839183908110611d4057fe5b6000918252602080832090910192909255838152600b90915260409020819055600a805490611d73906000198301612dfb565b5060008a8152600b60205260408120555b6001909a0199611851565b6001909b019a611844565b60008c1115611dac576000198c01600c555b50505050505050505050505050565b611dc3612d31565b611dcb612d31565b611dd3612d31565b6000806000611de0612d31565b611de8612d31565b611df0612d31565b8a9550600094508493505b898611611ea457600160a060020a038c1615611e8457600093505b600086815260208190526040902054841015611e7f5760008681526020819052604090208054600160a060020a038e16919086908110611e5257fe5b600091825260209091200154600160a060020a03161415611e74576001909401935b600190930192611e16565b611e99565b60008681526020819052604090205494909401935b600190950194611dfb565b84604051805910611eb25750595b9080825280602002602001820160405250925084604051805910611ed35750595b9080825280602002602001820160405250915084604051805910611ef45750595b90808252806020026020018201604052509050600094508a95505b8986116120fc57600093505b6000868152602081905260409020548410156120f157600160a060020a038c161561200e5760008681526020819052604090208054600160a060020a038e16919086908110611f6657fe5b600091825260209091200154600160a060020a03161415612009576000868152602081905260409020600101805485908110611f9e57fe5b906000526020600020900154828681518110611fb657fe5b602090810290910181019190915260008781529081905260409020600201805485908110611fe057fe5b906000526020600020900154818681518110611ff857fe5b602090810290910101526001909401935b6120e6565b600086815260208190526040902080548590811061202857fe5b600091825260209091200154600160a060020a031683868151811061204957fe5b600160a060020a0390921660209283029091018201526000878152908190526040902060010180548590811061207b57fe5b90600052602060002090015482868151811061209357fe5b6020908102909101810191909152600087815290819052604090206002018054859081106120bd57fe5b9060005260206000209001548186815181106120d557fe5b602090810290910101526001909401935b600190930192611f1b565b600190950194611f0f565b919b909a509098509650505050505050565b6000804333846040518381526c01000000000000000000000000600160a060020a0384160260208201526034810182805190602001908083835b602083106121675780518252601f199092019160209182019101612148565b6001836020036101000a038019825116818451161790925250505091909101945060409350505050519081900390206000818152600660205260409020818155600181018054600160a060020a03191633600160a060020a03161790559091506002018380516121db929160200190612e93565b50600081815260066020908152604080832060038101849055600481018890556007808201859055600590910184905587845290915290208054600181016122238382612dfb565b5060009182526020909120018190559392505050565b60125481565b600860205281600052604060002081815481101515610f1757fe5b60145490565b600c5481565b60155460009033600160a060020a0390811691161480612294575060175433600160a060020a039081169116145b151561229f57600080fd5b8215156122ab57600080fd5b506000828152600660205260409020600701819055815b92915050565b6122d0612d43565b8115156122dc57600080fd5b60008281526006602052604090819020906101009051908101604090815282548252600180840154600160a060020a0316602080850191909152600280860180549596958588019591948116156101000260001901169190910491601f8301819004810201905190810160405280929190818152602001828054600181600116156101000203166002900480156123b45780601f10612389576101008083540402835291602001916123b4565b820191906000526020600020905b81548152906001019060200180831161239757829003601f168201915b5050505050815260200160038201548152602001600482015460001916600019168152602001600582015481526020016006820180548060200260200160405190810160405280929190818152602001828054801561243c57602002820191906000526020600020905b8154600160a060020a0316815260019091019060200180831161241e575b505050505081526020016007820154815250509050919050565b600c5490565b601754600160a060020a031690565b60008080348690101561247d57600080fd5b4333856040518381526c01000000000000000000000000600160a060020a0384160260208201526034810182805190602001908083835b602083106124d35780518252601f1990920191602091820191016124b4565b6001836020036101000a038019825116818451161790925250505091909101945060409350505050519081900390206000818152600560205260409020818155600181018054600160a060020a03191633600160a060020a031617905560030187905560145490925085915081111561254b57506014545b600082815260056020819052604090912090810182905543600482015560020184805161257c929160200190612e93565b506000828152600560209081526040808320600a8101805460ff19169055600b8101849055600681018490556008908101849055438501845290915290208054600181016125ca8382612dfb565b506000918252602080832091909101849055600a8054858452600b9092526040909220819055600181016125fe8382612dfb565b506000918252602080832091909101849055600160a060020a033316825260189052604090208054600181016126348382612f0d565b60009283526020808420868552600590915260409093208054600c9093029093019182556001808401548184018054600160a060020a031916600160a060020a0390921691909117905560028085018054939594936126a6938386019390821615610100026000190190911604612f39565b5060038281015490820155600480830154908201556005808301549082015560068083015490820155600780830154908201556008808301549082015560098083015490820155600a80830154908201805460ff191660ff9092161515919091179055600b91820154910155509095945050505050565b60186020528160005260406000208181548110151561273857fe5b90600052602060002090600c0201600091509150508060000154908060010160009054906101000a9004600160a060020a031690806002018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156106e45780601f106106b9576101008083540402835291602001916106e4565b6000818152600660205260408120548190819015156127f757600080fd5b600084815260066020526040902060040154915081151561281757600080fd5b3382604051600160a060020a03929092166c0100000000000000000000000002825260148201526034016040519081900390206000818152600960205260409020549091506001901061286d5760009250612b24565b600081815260096020908152604080832060019081905587845260069092529091206005018054909101908190556013549010156128ed576000848152600660208190526040909120018054600181016128c78382612dfb565b5060009182526020909120018054600160a060020a03191633600160a060020a03161790555b6000828152600560208181526040808420600690810154898652925290922001541115612a23576000828152600560205260409020600701548414612957576000828152600560205260409020600781018054600983015560068201546008909201919091558490555b600084815260066020818152604080842060059081015487865292529283902091820155612a1b916101809051908101604090815282548252600180840154600160a060020a0316602080850191909152600280860180549596958588019591948116156101000260001901169190910491601f8301819004810201905190810160405280929190818152602001828054600181600116156101000203166002900480156110695780601f1061103e57610100808354040283529160200191611069565b809250612b24565b600082815260056020818152604080842060080154888552600690925290922001541115612b20576000828152600560208181526040808420600981018990558885526006835281852084015494879052929091526008820192909255612a1b916101809051908101604090815282548252600180840154600160a060020a0316602080850191909152600280860180549596958588019591948116156101000260001901169190910491601f8301819004810201905190810160405280929190818152602001828054600181600116156101000203166002900480156110695780601f1061103e57610100808354040283529160200191611069565b8092505b5050919050565b60105481565b60115481565b60135481565b6000806020830151600160a060020a03161415612b5957600080fd5b5060005b601860008360200151600160a060020a03168152602081019190915260400160002054811015612d2d57601860008360200151600160a060020a031681526020810191909152604001600020805482908110612bb557fe5b60009182526020918290206001600c909202010154600160a060020a031690830151600160a060020a0316148015612c2b5750601860008360200151600160a060020a031681526020810191909152604001600020805482908110612c1657fe5b60009182526020909120600c90910201548251145b15612d255781601860008460200151600160a060020a031681526020810191909152604001600020805483908110612c5f57fe5b90600052602060002090600c0201600082015181556020820151600182018054600160a060020a031916600160a060020a0392909216919091179055604082015181600201908051612cb5929160200190612e93565b50606082015181600301556080820151816004015560a0820151816005015560c0820151816006015560e0820151600782015561010082015181600801556101208201516009820155610140820151600a8201805460ff1916911515919091179055610160820151600b90910155505b600101612b5d565b5050565b60206040519081016040526000815290565b6101006040519081016040908152600080835260208301528101612d65612d31565b8152600060208201819052604082018190526060820152608001612d87612d31565b8152602001600081525090565b828054828255906000526020600020908101928215612deb579160200282015b82811115612deb5782518254600160a060020a031916600160a060020a039190911617825560209290920191600190910190612db4565b50612df7929150612fae565b5090565b815481835581811511612e1f57600083815260209020612e1f918101908301612fd2565b505050565b6101806040519081016040908152600080835260208301528101612e46612d31565b815260200160008152602001600081526020016000815260200160008152602001600080191681526020016000815260200160008019168152602001600015158152602001600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10612ed457805160ff1916838001178555612f01565b82800160010185558215612f01579182015b82811115612f01578251825591602001919060010190612ee6565b50612df7929150612fd2565b815481835581811511612e1f57600c0281600c028360005260206000209182019101612e1f9190612fec565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10612f725780548555612f01565b82800160010185558215612f0157600052602060002091601f016020900482015b82811115612f01578254825591600101919060010190612f93565b610d6e91905b80821115612df7578054600160a060020a0319168155600101612fb4565b610d6e91905b80821115612df75760008155600101612fd8565b610d6e91905b80821115612df7576000808255600182018054600160a060020a031916905561301e600283018261306b565b50600060038201819055600482018190556005820181905560068201819055600782018190556008820181905560098201819055600a8201805460ff19169055600b820155600c01612ff2565b50805460018160011615610100020316600290046000825580601f1061309157506130af565b601f0160209004906000526020600020908101906130af9190612fd2565b50565b60006130be8235613ac7565b9392505050565b6000601f82018390126130d757600080fd5b81356130ea6130e582613a6e565b613a43565b9150818183526020840193506020810190508385602084028201111561310f57600080fd5b60005b8381101561313b578161312588826130b2565b8452506020928301929190910190600101613112565b5050505092915050565b6000601f820183901261315757600080fd5b81356131656130e582613a6e565b9150818183526020840193506020810190508385602084028201111561318a57600080fd5b60005b8381101561313b57816131a088826131b6565b845250602092830192919091019060010161318d565b60006130be8235610d6e565b6000601f82018390126131d457600080fd5b81356131e26130e582613a8f565b915080825260208301602083018583830111156131fe57600080fd5b613209838284613ad8565b50505092915050565b60006020828403121561322457600080fd5b600061323084846130b2565b949350505050565b6000806040838503121561324b57600080fd5b600061325785856130b2565b9250506020613268858286016131b6565b9150509250929050565b60008060006060848603121561328757600080fd5b600061329386866130b2565b93505060206132a4868287016131b6565b92505060406132b5868287016131b6565b9150509250925092565b6000602082840312156132d157600080fd5b813567ffffffffffffffff8111156132e857600080fd5b613230848285016130c5565b6000806040838503121561330757600080fd5b823567ffffffffffffffff81111561331e57600080fd5b61332a858286016130c5565b9250506020613268858286016130b2565b60006020828403121561334d57600080fd5b600061323084846131b6565b60008060006060848603121561336e57600080fd5b600061337a86866131b6565b935050602084013567ffffffffffffffff81111561339757600080fd5b6133a3868287016130c5565b925050604084013567ffffffffffffffff8111156133c057600080fd5b6132b586828701613145565b600080604083850312156133df57600080fd5b60006133eb85856131b6565b925050602083013567ffffffffffffffff81111561340857600080fd5b613268858286016131c2565b6000806040838503121561342757600080fd5b600061325785856131b6565b60008060006060848603121561344857600080fd5b600061329386866131b6565b60008060006060848603121561346957600080fd5b600061347586866131b6565b9350506020613486868287016131b6565b925050604084013567ffffffffffffffff8111156134a357600080fd5b6132b5868287016131c2565b6134b881613ac7565b82525050565b60006134c982613abd565b8084526020840193506134db83613ab7565b60005b8281101561350b576134f18683516134af565b6134fa82613ab7565b6020969096019591506001016134de565b5093949350505050565b600061352082613abd565b80845260208401935061353283613ab7565b60005b8281101561350b576135488683516134af565b61355182613ab7565b602096909601959150600101613535565b600061356d82613abd565b8084526020840193508360208202850161358685613ab7565b60005b848110156135bd5783830388526135a18383516136b8565b92506135ac82613ab7565b602098909801979150600101613589565b50909695505050505050565b60006135d482613abd565b808452602084019350836020820285016135ed85613ab7565b60005b848110156135bd578383038852613608838351613766565b925061361382613ab7565b6020989098019791506001016135f0565b600061362f82613abd565b80845260208401935061364183613ab7565b60005b8281101561350b5761365786835161367a565b61366082613ab7565b602096909601959150600101613644565b6134b881613ad3565b6134b881610d6e565b600061368e82613abd565b8084526136a2816020860160208601613ae4565b6136ab81613b10565b9093016020019392505050565b6000610100830182516136cb858261367a565b5060208301516136de60208601826134af565b50604083015184820360408601526136f68282613683565b915050606083015161370b606086018261367a565b50608083015161371e608086018261367a565b5060a083015161373160a086018261367a565b5060c083015184820360c08601526137498282613515565b91505060e083015161375e60e086018261367a565b509392505050565b600061018083018251613779858261367a565b50602083015161378c60208601826134af565b50604083015184820360408601526137a48282613683565b91505060608301516137b9606086018261367a565b5060808301516137cc608086018261367a565b5060a08301516137df60a086018261367a565b5060c08301516137f260c086018261367a565b5060e083015161380560e086018261367a565b5061010083015161381a61010086018261367a565b5061012083015161382f61012086018261367a565b50610140830151613844610140860182613671565b5061016083015161375e61016086018261367a565b602081016122c282846134af565b602080825281016130be81846134be565b6060808252810161388981866134be565b9050818103602083015261389d8185613624565b905081810360408301526138b18184613624565b95945050505050565b602080825281016130be8184613562565b602080825281016130be81846135c9565b602081016122c28284613671565b602081016122c2828461367a565b60e08101613906828a61367a565b61391360208301896134af565b81810360408301526139258188613683565b9050613934606083018761367a565b613941608083018661367a565b61394e60a083018561367a565b61395b60c083018461367a565b98975050505050505050565b6101808101613976828f61367a565b613983602083018e6134af565b8181036040830152613995818d613683565b90506139a4606083018c61367a565b6139b1608083018b61367a565b6139be60a083018a61367a565b6139cb60c083018961367a565b6139d860e083018861367a565b6139e661010083018761367a565b6139f461012083018661367a565b613a02610140830185613671565b613a1061016083018461367a565b9d9c50505050505050505050505050565b602080825281016130be81846136b8565b602080825281016130be8184613766565b6000604051905081810181811067ffffffffffffffff82111715613a6657600080fd5b604052919050565b600067ffffffffffffffff821115613a8557600080fd5b5060209081020190565b600067ffffffffffffffff821115613aa657600080fd5b506020601f91909101601f19160190565b60200190565b6000815192915050565b600160a060020a031690565b151590565b82818337506000910152565b60005b83811015613aff578082015183820152602001613ae7565b83811115610c095750506000910152565b601f01601f1916905600a265627a7a72305820065f363d6834ca9dc2dcf4a3b6248acbb75302aa5dce101a6f387d1d000c5e876c6578706572696d656e74616cf50037";
  var dechataddr = "0xd344716b819fc0e8bb5935756e6ed8da6b3077b9";
  var devaddr = "0xd344716b819fc0e8bb5935756e6ed8da6b3077b9";
  code += "000000000000000000000000" + dechataddr.substr(2, 100);
  code += "000000000000000000000000" + devaddr.substr(2, 100);
  subchaindeploycode(baseaddr, subchainaddr, code, nonce);
}

function subchaindeploycode(baseaddr, subchainaddr, code, nonce) {
  sendshardingflagtx(
    baseaddr,
    subchainaddr,
    //1000000000000000000000000,
    0,
    code,
    nonce
  );
}

function sendshardingflagtx(baseaddr, subchainaddr, amount, code, n) {
  chain3.mc.sendTransaction({
    from: baseaddr,
    value: amount,
    to: subchainaddr,
    gas: "0", //'200000',
    gasPrice: chain3.mc.gasPrice,
    ShardingFlag: "0x1",
    data: code,
    nonce: n,
    via: "0xD814F2ac2c4cA49b33066582E4e97EBae02F2aB9"
  });

  console.log(
    "sending from:" + baseaddr + " to:" + subchainaddr + " with nonce:" + n
  );
}

function creatBoard(
  sender,
  subchainAddr,
  deployLwSolAdmin,
  marketableTokenAddr,
  rpcIp,
  boardName,
  picPath,
  num
) {
  var data = dechatmanagement.creatBoard.getData(
    subchainAddr,
    deployLwSolAdmin,
    marketableTokenAddr,
    rpcIp,
    boardName,
    picPath,
    num
  );
  sendtx(sender, dechatmanagement.address, "0", data);
}
